name: Generate Dependency Manifest

on:
  workflow_dispatch: # Allow manual triggers
  push:
    branches:
      - main
      - master
    paths:
      - '**.md'
      - '**.ts'
      - '**.js'
      - '**.py'
      - '**.go'
      - '**.rs'
      - 'package.json'
      - 'requirements.txt'
      - 'Cargo.toml'

permissions:
  contents: write # Required to commit manifest file
  issues: write # Required to create issues on errors

jobs:
  generate-manifest:
    name: Generate Dependency Manifest
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate manifest
        id: generate
        uses: pradeepmouli/dependabit/packages/action@main
        with:
          llm-provider: 'github-copilot'
          manifest-path: '.dependabit/manifest.json'
          min-confidence: '0.7'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display results
        run: |
          echo "Manifest generated at: ${{ steps.generate.outputs.manifest-path }}"
          echo "Dependencies found: ${{ steps.generate.outputs.dependencies-count }}"
          echo "Average confidence: ${{ steps.generate.outputs.average-confidence }}"

      - name: Commit manifest
        if: steps.generate.outputs.dependencies-count > 0
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .dependabit/manifest.json
          git diff-index --quiet HEAD || git commit -m "chore: update dependency manifest [skip ci]"
          git push

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Dependency manifest generation failed',
              body: `The dependency manifest generation workflow failed.
              
              **Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              Please review the logs and fix any issues.`,
              labels: ['dependabit', 'automation']
            });
